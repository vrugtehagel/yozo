#!/bin/bash

# Run the build.sh script when any file in this repo changes

# Move to the project root, so we don't serve the wrong directory
cd "$(dirname "$0")/.."

# Run a local server at localhost:8787 using php
php -q -S localhost:8787 -t dist/ &

# Save the process ID so we can kill it later
PHP_PID=$!

# Define an update function that runs the build script and shows some life
update(){
	clear
	bin/build
	echo "$(tput setaf 8)?$(tput init)" \
		"Last updated $(date +%T)."
}

# Touch a file to make sure serving doesn't immediately end
touch README.md

# Check for file changes every second. If there are any, run the updater
while sleep 1; do 

	# Find the files that changed in the last hour. If there are none, stop serving
	[[ $(find . -type f -mtime -1h -not -path "./dist/*") ]] || break

	# Find the files that changed in the last 2s. If there are none, continue
	# Setting it to 1s doesn't always find the files, not sure why
	[[ $(find . -type f -mtime -2s -not -path "./dist/*") ]] || continue

	# Something changed! Run the updater.
	update
done

# User is gone, time to stop serving. So, kill the PHP process
kill $PHP_PID

# Say why the script stopped
echo "$(tput setaf 8)?$(tput init)" \
	"Stopped serving due to inactivity."
